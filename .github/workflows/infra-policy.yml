# Reusable workflow: Infra Policy (v1.0.0)
name: Infra Policy
on:
  workflow_call:
    inputs:
      policy_dir:
        required: false
        type: string
        default: 'policies/conftest'
      target:
        required: false
        type: string
        default: '.'
      opa_version:
        required: false
        type: string
        default: ''
      opa_sha256:
        required: false
        type: string
        default: ''
      conftest_version:
        required: false
        type: string
        default: 'v0.66.0'
      conftest_checksums_sha256:
        required: false
        type: string
        default: '85c29310f05f07807f1ae340f61e9a3ff2e908dedf76cf78a2ecfdf76f7efa0d'

jobs:
  opa-conftest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - id: standards-ref
        name: Resolve standards ref
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${GITHUB_WORKFLOW_REF:-}" ] || [[ "${GITHUB_WORKFLOW_REF}" != *"@"* ]]; then
            echo "Unable to resolve standards ref from GITHUB_WORKFLOW_REF"
            exit 1
          fi
          echo "ref=${GITHUB_WORKFLOW_REF#*@}" >> "${GITHUB_OUTPUT}"

      - name: Checkout standards actions at workflow ref
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: julian-najas/clinical-standards
          ref: ${{ steps.standards-ref.outputs.ref }}
          path: .clinical-standards

      - name: Validate OPA override inputs
        shell: bash
        env:
          OPA_VERSION: ${{ inputs.opa_version }}
          OPA_SHA256: ${{ inputs.opa_sha256 }}
        run: |
          set -euo pipefail
          if [ -n "${OPA_SHA256}" ] && [ -z "${OPA_VERSION}" ]; then
            echo "opa_version is required when opa_sha256 is set"
            exit 1
          fi

      - name: Install OPA (default pin)
        if: ${{ inputs.opa_version == '' }}
        uses: ./.clinical-standards/actions/setup-opa

      - name: Install OPA (override)
        if: ${{ inputs.opa_version != '' }}
        uses: ./.clinical-standards/actions/setup-opa
        with:
          opa_version: ${{ inputs.opa_version }}
          opa_sha256: ${{ inputs.opa_sha256 }}

      - name: Install Conftest
        shell: bash
        env:
          CONFTEST_VERSION: ${{ inputs.conftest_version }}
          CONFTEST_CHECKSUMS_SHA256: ${{ inputs.conftest_checksums_sha256 }}
        run: |
          set -euo pipefail
          conftest_archive="conftest_Linux_x86_64.tar.gz"
          conftest_base_url="https://github.com/open-policy-agent/conftest/releases/download/${CONFTEST_VERSION}"

          curl -fsSL --retry 3 --retry-all-errors -o checksums.txt "${conftest_base_url}/checksums.txt"
          echo "${CONFTEST_CHECKSUMS_SHA256}  checksums.txt" | sha256sum -c -

          curl -fsSL --retry 3 --retry-all-errors -o "${conftest_archive}" "${conftest_base_url}/${conftest_archive}"
          grep " ${conftest_archive}$" checksums.txt | sha256sum -c -

          tar -xzf "${conftest_archive}" conftest
          chmod +x conftest
          sudo mv conftest /usr/local/bin/conftest

      - name: Ejecutar Conftest sobre manifiestos
        run: |
          conftest test ${{ inputs.target }} --policy ${{ inputs.policy_dir }}