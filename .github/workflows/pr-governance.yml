name: PR Governance

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  governance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Governance baseline check
        run: |
          test -f README.md
          test -f VERSIONING.md
      - name: Enforce non-hidden artifact defaults
        shell: bash
        run: |
          set -euo pipefail
          failures=0

          while IFS= read -r -d '' file; do
            if ! awk -v file="$file" '
              function indent(s) { match(s, /^[[:space:]]*/); return RLENGTH }
              BEGIN { in_artifact_block = 0; base_indent = -1; bad = 0 }
              {
                line = $0
                current_indent = indent(line)

                if (in_artifact_block && current_indent <= base_indent && line !~ /^[[:space:]]*$/) {
                  in_artifact_block = 0
                }

                if (line ~ /^[[:space:]]*(artifacts-dir|artifacts_dir):[[:space:]]*$/) {
                  in_artifact_block = 1
                  base_indent = current_indent
                  next
                }

                if (in_artifact_block && line ~ /^[[:space:]]*default:[[:space:]]*/) {
                  value = line
                  sub(/^[[:space:]]*default:[[:space:]]*/, "", value)
                  sub(/^[[:space:]]*["\047]?/, "", value)
                  if (value ~ /^\./) {
                    printf "%s:%d:%s\n", file, NR, line
                    bad = 1
                  }
                }
              }
              END { exit bad ? 1 : 0 }
            ' "$file"; then
              failures=1
            fi
          done < <(find actions .github/workflows -type f \( -name "*.yml" -o -name "*.yaml" \) -print0)

          if [ "${failures}" -ne 0 ]; then
            echo "Hidden artifact defaults are not allowed. Use paths like artifacts/... instead."
            exit 1
          fi
      - name: Enforce SHA-pinned third-party actions
        shell: bash
        run: |
          set -euo pipefail
          failures=0

          while IFS= read -r -d '' file; do
            while IFS= read -r line; do
              stripped="${line%%#*}"
              if [[ "${stripped}" =~ ^[[:space:]]*-[[:space:]]*uses:[[:space:]]*(.+)$ ]]; then
                raw_ref="${BASH_REMATCH[1]}"
              elif [[ "${stripped}" =~ ^[[:space:]]*uses:[[:space:]]*(.+)$ ]]; then
                raw_ref="${BASH_REMATCH[1]}"
              else
                continue
              fi

              ref="$(echo "${raw_ref}" | sed -E "s/^[[:space:]]+|[[:space:]]+$//g; s/^['\\\"]//; s/['\\\"]$//")"
              if [ -z "${ref}" ]; then
                continue
              fi

              if [[ "${ref}" == ./* ]] || [[ "${ref}" == docker://* ]]; then
                continue
              fi

              if [[ "${ref}" != *@* ]]; then
                echo "${file}: uses entry without pinned ref: ${ref}"
                failures=1
                continue
              fi

              version_ref="${ref##*@}"
              if [[ ! "${version_ref}" =~ ^[0-9a-fA-F]{40}$ ]]; then
                echo "${file}: uses entry must pin a full SHA: ${ref}"
                failures=1
              fi
            done < "${file}"
          done < <(find .github/workflows actions -type f \( -name "*.yml" -o -name "*.yaml" \) -print0)

          if [ "${failures}" -ne 0 ]; then
            echo "Third-party actions must be pinned to a full commit SHA."
            exit 1
          fi
