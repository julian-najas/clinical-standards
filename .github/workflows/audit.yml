

# Reusable workflow: Clinical Audit (v1.0.0)
#
# Inputs:
#   repo_type: Tipo de repositorio (critical, standard, etc.)
#   python_version: Versión de Python (default: 3.11)
#   semgrep_config: Ruta a config de Semgrep (default: .semgrep.yml)
# Outputs:
#   Artifacts en artifacts/ (report.md, gitleaks, semgrep, etc.)
#
name: Clinical Audit
on:
  workflow_call:
    inputs:
      repo_type:
        required: true
        type: string
      python_version:
        required: false
        type: string
        default: '3.11'
      semgrep_config:
        required: false
        type: string
        default: '.semgrep.yml'
jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Preparar carpeta artifacts
        run: mkdir -p artifacts
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python_version }}
      - name: P0 - Gitleaks (secret scanning)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: "detect --source=. --report-path=artifacts/gitleaks-report.json --exit-code=1"
      - name: P0 - Audit Pack (ruff, pip-audit, pytest)
        uses: ./actions/audit-pack/
        with:
          python_version: ${{ inputs.python_version }}
      - name: P1 - Semgrep
        run: |
          pip install semgrep
          semgrep --config ${{ inputs.semgrep_config }} --json > artifacts/semgrep-report.json || true
      - name: Generar artifacts/report.md
        run: |
          echo "# Clinical Audit Report" > artifacts/report.md
          echo "\n## Gitleaks" >> artifacts/report.md
          if [ -s artifacts/gitleaks-report.json ]; then
            cat artifacts/gitleaks-report.json >> artifacts/report.md
          else
            echo "No gitleaks findings" >> artifacts/report.md
          fi
          echo "\n## Semgrep" >> artifacts/report.md
          if [ -s artifacts/semgrep-report.json ]; then
            cat artifacts/semgrep-report.json >> artifacts/report.md
          else
            echo "No semgrep findings" >> artifacts/report.md
          fi
          echo "\n## Resumen" >> artifacts/report.md
          echo "- Gitleaks: $(jq length artifacts/gitleaks-report.json 2>/dev/null || echo 0) findings" >> artifacts/report.md
          echo "- Semgrep: $(jq '.results | length' artifacts/semgrep-report.json 2>/dev/null || echo 0) findings" >> artifacts/report.md
      - name: Subir artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clinical-audit-artifacts
          path: artifacts/
      - name: Enforcement por repo_type
        if: ${{ inputs.repo_type == 'critical' }}
        run: |
          echo "Enforcement estricto para repositorios críticos"
          # Aquí puedes añadir lógica de enforcement según el tipo de repo
      - name: Estado global del audit
        run: |
          echo "Audit finalizado. Revisa artifacts/report.md para el resumen y detalles."