name: Clinical Audit

on:
  workflow_call:
    inputs:
      repo_type:
        required: true
        type: string
      python_version:
        required: false
        type: string
        default: '3.11'
      semgrep_config:
        required: false
        type: string
        default: '.semgrep.yml'
      semgrep_version:
        required: false
        type: string
        default: '1.145.0'

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Prepare artifacts directory
        run: mkdir -p artifacts

      - id: standards-ref
        name: Resolve standards ref
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${GITHUB_WORKFLOW_REF:-}" ] || [[ "${GITHUB_WORKFLOW_REF}" != *"@"* ]]; then
            echo "Unable to resolve standards ref from GITHUB_WORKFLOW_REF"
            exit 1
          fi
          echo "ref=${GITHUB_WORKFLOW_REF#*@}" >> "${GITHUB_OUTPUT}"

      - name: Checkout standards actions at workflow ref
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: julian-najas/clinical-standards
          ref: ${{ steps.standards-ref.outputs.ref }}
          path: .clinical-standards

      - name: P0 - Gitleaks (secret scanning)
        id: gitleaks
        continue-on-error: true
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2
        with:
          args: >-
            detect --source=. --no-banner --redact
            --report-format json --report-path=artifacts/gitleaks-report.json
            --exit-code=1

      - name: P0 - Audit Pack (ruff, mypy, pytest)
        uses: ./.clinical-standards/actions/audit-pack
        with:
          python_version: ${{ inputs.python_version }}
          install-command: >-
            python -m pip install --upgrade pip &&
            pip install ruff mypy pytest

      - name: P1 - Semgrep (pinned engine)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install "semgrep==${{ inputs.semgrep_version }}"
          semgrep --version
          semgrep --config "${{ inputs.semgrep_config }}" --json --output artifacts/semgrep-report.json || true

      - name: Generate artifacts/report.md
        shell: bash
        run: |
          echo "# Clinical Audit Report" > artifacts/report.md

          echo "" >> artifacts/report.md
          echo "## Gitleaks" >> artifacts/report.md
          if [ -s artifacts/gitleaks-report.json ]; then
            echo "- Findings: $(jq 'length' artifacts/gitleaks-report.json 2>/dev/null || echo 0)" >> artifacts/report.md
          else
            echo "- No gitleaks report generated" >> artifacts/report.md
          fi

          echo "" >> artifacts/report.md
          echo "## Semgrep" >> artifacts/report.md
          if [ -s artifacts/semgrep-report.json ]; then
            echo "- Findings: $(jq '.results | length' artifacts/semgrep-report.json 2>/dev/null || echo 0)" >> artifacts/report.md
          else
            echo "- No semgrep report generated" >> artifacts/report.md
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: clinical-audit-artifacts
          path: artifacts/

      - name: Enforce gitleaks failures
        if: ${{ steps.gitleaks.outcome == 'failure' }}
        run: |
          echo "Gitleaks found leaks. Failing workflow."
          exit 1

      - name: Enforcement by repo_type
        if: ${{ inputs.repo_type == 'critical' }}
        run: |
          echo "Strict enforcement for critical repositories"