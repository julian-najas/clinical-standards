name: Self-test (standards enforcement)

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  schema-registry-check:
    name: Schema registry integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.11"

      - name: Regenerate registry and verify no diff
        shell: bash
        run: |
          set -euo pipefail
          python scripts/generate_schema_registry.py
          git diff --exit-code

  opa-policy-tests:
    name: OPA policy tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Install OPA
        shell: bash
        run: |
          set -euo pipefail
          OPA_VERSION="0.63.0"
          curl -L -o opa "https://openpolicyagent.org/downloads/v${OPA_VERSION}/opa_linux_amd64_static"
          chmod +x opa
          sudo mv opa /usr/local/bin/opa
          opa version

      - name: Run OPA tests
        shell: bash
        run: |
          set -euo pipefail
          opa test policies/clinical -v

  contract-tests:
    name: Contract tests (schemas + OPA)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.11"

      - name: Install MCP runtime (dev)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          python -m pip install -e "mcp/python[dev]"
          python -m pip install jsonschema

      - name: Install OPA
        shell: bash
        run: |
          set -euo pipefail
          OPA_VERSION="0.63.0"
          curl -L -o opa "https://openpolicyagent.org/downloads/v${OPA_VERSION}/opa_linux_amd64_static"
          chmod +x opa
          sudo mv opa /usr/local/bin/opa
          opa version

      - name: Run contract tests
        shell: bash
        run: |
          set -euo pipefail
          pytest -q mcp/python/tests

  audit-pack-pass:
    name: audit-pack / PASS path
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Run audit-pack (PASS)
        uses: ./actions/audit-pack
        with:
          python_version: "3.11"
          artifacts-dir: "artifacts/self-test/pass"
          artifact-name: "self-test-audit-pass"
          install-command: >
            python -m pip install -U pip &&
            python -m pip install -e "examples/python-service[dev]"
          lint-command: >
            cd examples/python-service &&
            ruff check . &&
            ruff format --check .
          typecheck-command: >
            cd examples/python-service &&
            mypy src
          test-command: >
            cd examples/python-service &&
            pytest -q -k "not intentional_fail"
          run-lint: "true"
          run-typecheck: "true"
          run-tests: "true"
          enable_clinical: "false"

      - name: Assert PASS artifacts exist
        shell: bash
        run: |
          set -euo pipefail
          test -f artifacts/self-test/pass/summary.txt
          grep -q "overall_failed=0" artifacts/self-test/pass/summary.txt
          test -f artifacts/self-test/pass/lint.exit
          test -f artifacts/self-test/pass/typecheck.exit
          test -f artifacts/self-test/pass/tests.exit

  audit-pack-fail:
    name: audit-pack / FAIL path (must fail deterministically)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Run audit-pack (expected FAIL)
        id: audit_fail
        continue-on-error: true
        uses: ./actions/audit-pack
        with:
          python_version: "3.11"
          artifacts-dir: "artifacts/self-test/fail"
          artifact-name: "self-test-audit-fail"
          install-command: >
            python -m pip install -U pip &&
            python -m pip install -e "examples/python-service[dev]"
          lint-command: >
            cd examples/python-service &&
            ruff check . &&
            ruff format --check .
          typecheck-command: >
            cd examples/python-service &&
            mypy src
          test-command: >
            cd examples/python-service &&
            pytest -q
          run-lint: "true"
          run-typecheck: "true"
          run-tests: "true"
          enable_clinical: "false"

      - name: Assert FAIL behavior is correct
        shell: bash
        run: |
          set -euo pipefail
          # The action should fail (but we allowed workflow continuation)
          if [ "${{ steps.audit_fail.outcome }}" != "failure" ]; then
            echo "Expected audit-pack step outcome=failure, got: ${{ steps.audit_fail.outcome }}"
            exit 1
          fi

          # Artifacts must still exist and report must indicate failure
          test -f artifacts/self-test/fail/summary.txt
          grep -q "overall_failed=1" artifacts/self-test/fail/summary.txt

          # Confirm tests failed (exit code non-zero)
          test -f artifacts/self-test/fail/tests.exit
          code="$(cat artifacts/self-test/fail/tests.exit)"
          if [ "$code" = "0" ]; then
            echo "Expected tests.exit != 0, got 0"
            exit 1
          fi

  standards-smoke:
    name: Standards smoke (docs + structure)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Validate required docs exist
        shell: bash
        run: |
          set -euo pipefail
          test -f VERSIONING.md
          test -f CHANGELOG.md
          test -f docs/REFERENCE.md
          test -d actions/audit-pack
          test -d examples/python-service

  mcp-runtime-smoke:
    name: MCP runtime smoke (multiagent-clinic)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Python 3.11
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Install MCP runtime (editable)
        run: |
          python -m pip install -U pip
          python -m pip install -e "mcp/python[dev]"

      - name: Install example requirements
        run: |
          python -m pip install -r examples/multiagent-clinic/requirements.txt || true
          # No requirements.txt por defecto, ignora error

      - name: Run multiagent orchestrator
        working-directory: examples/multiagent-clinic
        run: |
          python orchestrator.py

      - name: Assert eventlog exists and contains events
        working-directory: examples/multiagent-clinic
        run: |
          set -euo pipefail
          test -f eventlog/events.jsonl
          lines=$(wc -l < eventlog/events.jsonl)
          if [ "$lines" -lt 3 ]; then
            echo "Eventlog demasiado corto ($lines lÃ­neas)"
            exit 1
          fi

  mcp-hybrid-smoke:
    name: MCP hybrid smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.11"

      - name: Install MCP runtime
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          python -m pip install -e "mcp/python[dev]"

      - name: Run hybrid demo
        shell: bash
        run: |
          set -euo pipefail
          python examples/multiagent-clinic/orchestrator_demo.py
          test -f artifacts/mcp/events.jsonl
          test -f artifacts/mcp/run.json
          test -f artifacts/mcp/outbox.sqlite3

      - name: Install OPA
        shell: bash
        run: |
          set -euo pipefail
          OPA_VERSION="0.63.0"
          curl -L -o opa "https://openpolicyagent.org/downloads/v${OPA_VERSION}/opa_linux_amd64_static"
          chmod +x opa
          sudo mv opa /usr/local/bin/opa
          opa version

      - name: Validate MCP artifacts against JSON Schemas
        shell: bash
        run: |
          set -euo pipefail
          python -c "import jsonschema; print('jsonschema ok')"
          python mcp/python/clinical_mcp/validate_artifacts.py

      - name: OPA evaluate events
        shell: bash
        run: |
          set -euo pipefail
          python mcp/python/clinical_mcp/opa_eval_events.py

      - name: Assert no PII patterns in artifacts (strict)
        shell: bash
        run: |
          set -euo pipefail
          ! grep -E "\b[0-9]{8}[A-Z]\b" -n artifacts/mcp/events.jsonl
          ! grep -E "@" -n artifacts/mcp/events.jsonl
